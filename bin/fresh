#!/bin/bash -e

FRESH_RCFILE="${FRESH_RCFILE:-$HOME/.freshrc}"
FRESH_PATH="${FRESH_PATH:-$HOME/.fresh}"
FRESH_LOCAL="${FRESH_LOCAL:-$HOME/.dotfiles}"

bin_path() {
  (cd "$(dirname "$0")" && pwd)
}

fresh_install() {
  # create new output directory
  [ ! -e "$FRESH_PATH/build.new" ] || rm -rf "$FRESH_PATH/build.new"
  mkdir -p "$FRESH_PATH/build.new"
  echo "export PATH=\"$(bin_path):\$PATH\"" >> "$FRESH_PATH/build.new/shell.sh"

  # freshrc DSL
  fresh() {
    if [ -z "$2" ]; then
      cat "$FRESH_LOCAL/$1" >> "$FRESH_PATH/build.new/shell.sh"
    else
      local REPO_DIR="$FRESH_PATH/source/$1"
      mkdir -p "$(dirname "$REPO_DIR")"
      if ! [ -e "$REPO_DIR" ]; then
        git clone "http://github.com/$1" "$REPO_DIR"
      fi
      cat "$REPO_DIR/$2" >> "$FRESH_PATH/build.new/shell.sh"
    fi
  }

  # load the freshrc file
  if [ -e "$FRESH_RCFILE" ]; then
    source "$FRESH_RCFILE"
  fi

  # move output into place
  [ ! -e "$FRESH_PATH/build" ] || rm -rf "$FRESH_PATH/build"
  mv "$FRESH_PATH/build.new" "$FRESH_PATH/build"
}

fresh_install
